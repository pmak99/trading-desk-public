# IV Crush 2.0 System - Overview & Architecture

**Date:** 2025-11-12  
**Status:** Production-Ready with 4-Week Hardening Plan  
**Version:** 2.0-Complete

---

## Executive Summary

Complete redesign of IV crush trading system with **production-hardened architecture**. Focuses on quantitative volatility risk premium (VRP) strategy with clean code, full testing, zero technical debt, and enterprise-grade resilience patterns.

**Timeline:** 21 days (MVP) + 25 days (Phases 1-4) = **46 days to fully production-ready live trading**

**Architecture:** Dependency injection, type safety, comprehensive error handling, async concurrency, circuit breakers, retry logic, health checks, tracing, persistent caching, timezone support.

**Testing:** 80%+ coverage with unit, integration, property-based, and performance tests

---

## Strategy Overview

### Core Thesis: Volatility Risk Premium (VRP)

**What:** Sell options when implied volatility is inflated relative to historical realized moves.

**Entry:** 3:00-4:00 PM ET on trading day
- **AMC (After Market Close):** Enter same day, earnings after 4 PM
- **BMO (Before Market Open):** Enter day before, earnings next morning

**Exit:** Next day at 9:30 AM after IV crush

**Edge:** VRP Ratio = Implied Move / Historical Mean Move
- **Excellent:** 2.0x+ (implied move is double historical average)
- **Good:** 1.5-2.0x
- **Marginal:** 1.2-1.5x
- **Skip:** < 1.2x (no edge)

---

## 46-Day Implementation Timeline

### DAYS 1-21: CORE MVP SYSTEM âœ…

**Week 0 (Days 1-3): Foundation**
- Domain types: Money, Percentage, Strike, OptionChain, OptionQuote
- Error handling: Result[T, Error] pattern
- Configuration: Environment-based, centralized
- Database schema: 5 tables (earnings, metadata, prices, logs, rate limits)

**Week 1 (Days 4-10): Core Metrics (Tier 1)**
- ImpliedMoveCalculator: Straddle-based implied moves
- VRPCalculator: VRP ratio with Sharpe-like metric
- Risk-adjusted edge calculation
- Unit tests for calculators

**Week 1.5 (Days 7-10): Data Enrichment (Tier 2)**
- ConsistencyAnalyzer: Historical move consistency (MAD-based)
- SkewAnalyzer: Put/call IV skew detection
- TermStructureAnalyzer: Multi-expiration IV analysis
- ExecutionQualityFilter: Liquidity checks

**Week 2 (Days 11-14): Integration**
- Dependency injection container
- CLI scripts: analyze.py, scan.py, backfill.py
- API clients: Tradier (options), Alpha Vantage (earnings/prices)
- Cache layer: In-memory TTL cache
- Rate limiting: Token bucket for Alpha Vantage

**Week 3 (Days 15-21): Production**
- Unit tests (80%+ coverage)
- Integration tests
- Database backfill: 100+ tickers, 12 quarters each
- Performance baselines established
- Documentation

**Result:** MVP working. Single ticker analysis complete. Database populated. Ready for MVP testing.

---

### DAYS 22-28: PHASE 1 - CRITICAL RESILIENCE ðŸš€

**Why:** Current system is synchronous and fragile. Need concurrency, retry logic, and API resilience.

**A. Async/Await Layer (Days 22-23)**

Add `src/application/async_metrics/`:
- AsyncImpliedMoveCalculator - Parallel ticker processing
- AsyncTickerAnalyzer - Concurrent analysis with semaphore
- asyncio.gather() for batch operations
- Thread pool executor for CPU-bound work

**Impact:** 50 tickers: 50 seconds â†’ 2-3 seconds (20x faster)

**Code template:**
```python
class AsyncTickerAnalyzer:
    async def analyze_many(tickers, earnings_date, exp, max_concurrent=10):
        semaphore = asyncio.Semaphore(max_concurrent)
        tasks = [analyze_with_limit(t) for t in tickers]
        return await asyncio.gather(*tasks)
```

**B. Retry Decorator with Exponential Backoff (Days 23-24)**

Add `src/utils/retry.py`:
- @async_retry decorator for async functions
- @sync_retry decorator for sync functions
- Configurable: max_attempts (3x default), backoff_base (2^n), max_backoff (60s)
- Exponential backoff: 1s, 2s, 4s... + jitter to prevent thundering herd

**Integration points:**
- Wrap Tradier.get_option_chain()
- Wrap Alpha Vantage API calls
- Automatic retry on: RequestException, Timeout, ConnectionError

**Code template:**
```python
@sync_retry(max_attempts=3, backoff_base=2)
def get_option_chain(ticker, exp):
    response = requests.get(url, timeout=10)
    response.raise_for_status()
    return chain
```

**C. Circuit Breaker Pattern (Days 24-25)**

Add `src/utils/circuit_breaker.py`:
- CircuitBreaker class with three states: CLOSED, OPEN, HALF_OPEN
- Opens after N consecutive failures (5 default)
- Recovers automatically after timeout (60s default)
- Prevents cascading failures across tickers

**Integration:** Wrap Tradier API in container

**Code template:**
```python
@circuit_breaker(name="tradier_api", failure_threshold=5, recovery_timeout=60)
def get_option_chain(ticker, exp):
    ...
```

**D. Correlation ID Tracing (Days 25-26)**

Add `src/utils/tracing.py`:
- ContextVar for request correlation ID
- CorrelationIdFilter for logging
- Every request automatically tagged with UUID
- All logs include [uuid] prefix for tracing

**Integration:** Update src/utils/logging.py to include filter

**Log output:**
```
[a1b2c3d4] 14:30:00 INFO - Starting analysis
[a1b2c3d4] 14:30:01 DEBUG - Fetching chain...
[a1b2c3d4] 14:30:02 INFO - Completed
```

**E. Health Check Service (Days 26-27)**

Add `src/application/services/health.py`:
- Async health check for all dependencies
- Checks: Tradier API, Alpha Vantage, Database, Cache
- Returns: Latencies, error messages, overall status
- Integration: Container and /health endpoint

**F. Integration Testing (Days 27-28)**

Create `tests/integration/test_resilience.py`:
- Async layer: 50 tickers < 5 seconds
- Retry logic: Timeout triggers retry, succeeds on retry
- Circuit breaker: Opens after 5 failures, recovers after 60s
- Correlation IDs: Present in all logs
- Health check: All services healthy

**Result after Phase 1:**
- âœ… 50 tickers process in 2-3 seconds (not 50s)
- âœ… API timeouts retry 3x automatically
- âœ… Circuit breaker prevents cascade failures
- âœ… Every request traceable via correlation ID
- âœ… Health check confirms system ready
- âœ… Can handle 95%+ of transient failures

---

### DAYS 29-35: PHASE 2 - DATA PERSISTENCE & OPERATIONS ðŸ“‹

**Why:** Restart loses cached data. No config validation. No timezone safety. Can't track performance.

**A. Persistent Hybrid Cache (Day 29)**

Add `src/infrastructure/cache/hybrid_cache.py`:
- L1 Cache: In-memory (fast, 30s TTL, volatile)
- L2 Cache: SQLite (persistent, 5m TTL, survives restart)
- Lookup: L1 â†’ L2 â†’ API
- Automatic promotion: L2 hit promoted to L1

**Integration:** CachedOptionsDataProvider wraps Tradier API

**Impact:** Restart mid-scan doesn't require re-fetching all option chains

**B. Configuration Validation (Day 30)**

Add `src/config/validation.py`:
- Validates at startup (fail fast)
- Checks: API keys present, DB path exists, thresholds valid, timeouts positive
- Error reporting: Clear messages per issue
- Prevents silent failures at runtime

**Integration:** Called in container creation

**C. Timezone-Aware Types (Day 31)**

Enhance `src/domain/types.py`:
- All timestamps use UTC internally (timezone.utc)
- Market timezone: zoneinfo.ZoneInfo("America/New_York")
- Helper: market_now() returns current market time
- TickerAnalysisV2 with timezone properties:
  - earnings_time_market: Earnings in market timezone
  - entry_time_market: Entry in market timezone
  - minutes_to_earnings: Minutes until earnings
  - is_premarket: Boolean flag
  - is_regular_hours: Boolean flag

**Impact:** Earnings times correct even across DST changes

**D. Enhanced Data Structures (Day 32)**

Add to types:
- **Greeks:** delta, gamma, vega, theta for straddles
- **ImpliedMoveV2:** Add Greeks, probability bounds (1Ïƒ, 2Ïƒ)
- **HistoricalMoveV2:** Add volume_before, volume_earnings, volume_ratio
- **ExpirationInfo:** days_to_expiration, is_monthly, settlement_type (AM/PM)
- **PricingContext:** Market state, time flags, minutes to earnings

**E. Performance Tracking (Day 33)**

Add `src/utils/performance.py`:
- @track_performance decorator
- Auto-logs function latency
- Alerts if exceeds baseline
- Tracks: count, avg, min, max, p95, p99

**Integration:** Applied to all critical functions

**Code template:**
```python
@track_performance
def analyze_ticker(ticker, earnings_date, exp):
    # Automatic latency tracking
    ...
```

**F. Integration Testing (Days 34-35)**

Create `tests/integration/test_operations.py`:
- Cache persists across restart
- Config validation catches all errors
- Timezone conversions correct
- Performance within baselines

**Result after Phase 2:**
- âœ… Restart preserves cached data (no re-fetching)
- âœ… All configs validated at startup
- âœ… Earnings times guaranteed correct
- âœ… Slow functions automatically logged
- âœ… Enhanced types capture more market data

---

### DAYS 36-42: PHASE 3 - PRODUCTION DEPLOYMENT ðŸŽ¯

**Why:** Need confidence before paper trading. Must handle edge cases, load test, document.

**A. Edge Case Tests (Day 36)**

Create `tests/unit/test_edge_cases.py`:
- Stock price = $0 (should fail gracefully)
- Single quarter history (insufficient data)
- Extreme IV crush 10x (rare but valid)
- Zero bid-ask spread (impossible, test robustness)
- Negative earnings move (tests logic edge)
- No options available (graceful degradation)

**B. Load Testing (Days 37-40)**

Create `tests/performance/test_load.py`:
- Scan 50 tickers: < 5 seconds (verify Phase 1)
- Scan 100 tickers: < 10 seconds (scale limit)
- Concurrent 10 scanners: All complete without errors
- Database locked: Handles gracefully
- Performance: Track and baseline all operations

**C. Deployment Runbook (Day 41)**

Create `DEPLOYMENT.md`:
- Pre-deployment checklist
- Step-by-step setup
- Health check validation
- Monitoring procedures
- Troubleshooting guide
- Rollback procedures
- Docker deployment (optional)

**D. Documentation (Day 42)**

- Updated architecture diagrams
- Operations guide
- Performance baselines
- Troubleshooting common issues

**Result after Phase 3:**
- âœ… Edge cases handled (20+ test scenarios)
- âœ… Load testing verified (100 tickers)
- âœ… Deployment procedures documented
- âœ… Ready for paper trading

---

### DAYS 43-46: PHASE 4 - ALGORITHMIC OPTIMIZATION ðŸ§ 

**Why:** Improve edge detection for rare, high-confidence setups.

**A. Polynomial Skew Fitting (Day 43)**

Enhance `src/application/metrics/skew.py`:
- Use 5+ OTM points instead of single pair
- Fit 2nd degree polynomial (parabola)
- Extract: skew_atm (ATM skew), curvature, strength
- Classify: smile (both expensive) vs smirk (normal)
- Detect: directional bias in skew

**Impact:** Better skew signal, catches directional bias

**B. Exponential-Weighted Consistency (Day 44)**

Enhance `src/application/metrics/consistency.py`:
- Recent quarters weighted more heavily
- Calculate trend: slope of historical moves
- Detect: Increasing (bad signal), decreasing, or stable
- Result: Trend flag + trustworthiness score

**Impact:** Recent earnings moves weighted appropriately

**C. Straddle Interpolation (Day 45)**

Add `src/application/metrics/implied_move_interpolated.py`:
- Interpolate between nearest strikes
- Avoids rounding error when no exact ATM
- Smoother implied move calculation

**D. Final Testing & Tuning (Day 46)**

- Backtest algorithms against historical earnings
- Tune thresholds for optimal edge
- Performance validation

**Result after Phase 4:**
- âœ… Better edge detection (polynomial skew)
- âœ… Recent data weighted properly (exp consistency)
- âœ… Smoother calculations (interpolation)
- âœ… Algorithm fully optimized

---

## Architecture Overview

### Layered Design

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CLI Layer                               â”‚
â”‚   analyze.py, scan.py, backfill.py, health_check.py       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Application Layer                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ASYNC (Phase 1)                                        â”‚ â”‚
â”‚  â”‚ - AsyncTickerAnalyzer (concurrent, 20x faster)        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ SYNC METRICS (Core Logic)                              â”‚ â”‚
â”‚  â”‚ - Tier 1: ImpliedMove, VRP                            â”‚ â”‚
â”‚  â”‚ - Tier 2: Consistency, Skew, TermStructure           â”‚ â”‚
â”‚  â”‚ - Tier 3: MarketCap, IV/HV                           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ SERVICES                                               â”‚ â”‚
â”‚  â”‚ - HealthCheckService (Phase 1)                        â”‚ â”‚
â”‚  â”‚ - AnalyzerService (core logic)                        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Infrastructure Layer                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ RESILIENCE (Phase 1)                                   â”‚ â”‚
â”‚  â”‚ - @circuit_breaker (Tradier)                          â”‚ â”‚
â”‚  â”‚ - @retry with exponential backoff                     â”‚ â”‚
â”‚  â”‚ - Multi-source provider (fallbacks)                   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ APIs & Cache                                           â”‚ â”‚
â”‚  â”‚ - Tradier (real-time options)                         â”‚ â”‚
â”‚  â”‚ - Alpha Vantage (earnings, prices)                    â”‚ â”‚
â”‚  â”‚ - Hybrid Cache: L1 memory + L2 SQLite (Phase 2)      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Database & Repositories                                â”‚ â”‚
â”‚  â”‚ - SQLite with 5 tables                                â”‚ â”‚
â”‚  â”‚ - Proper indexes and constraints                      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Domain Layer                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Types (Immutable, Frozen Dataclasses)                  â”‚ â”‚
â”‚  â”‚ - Money, Percentage, Strike (value objects)           â”‚ â”‚
â”‚  â”‚ - OptionChain, OptionQuote (efficient lookups)        â”‚ â”‚
â”‚  â”‚ - ImpliedMove, VRPResult, HistoricalMove             â”‚ â”‚
â”‚  â”‚ - Enhanced: Greeks, Volume, Timezone, ExpirationInfo  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Errors (Result[T, Error] Pattern)                      â”‚ â”‚
â”‚  â”‚ - Result: Ok(value) or Err(error)                     â”‚ â”‚
â”‚  â”‚ - Error: Code + context dict                          â”‚ â”‚
â”‚  â”‚ - No silent failures                                  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Dependency Injection Container

All dependencies injected via constructor. 100% testable.

```python
class Container:
    # Config
    @property
    def config(self) -> Config: ...
    
    # Infrastructure
    @property
    def tradier(self) -> TradierAPI: ...
    @property
    def alphavantage(self) -> AlphaVantageAPI: ...
    @property
    def hybrid_cache(self) -> HybridCache: ...  # Phase 2
    @property
    def health_check(self) -> HealthCheckService: ...  # Phase 1
    
    # Application
    @property
    def implied_move_calc(self) -> ImpliedMoveCalculator: ...
    @property
    def vrp_calc(self) -> VRPCalculator: ...
    @property
    def consistency_analyzer(self) -> ConsistencyAnalyzer: ...
    
    # Async (Phase 1)
    @property
    def async_analyzer(self) -> AsyncTickerAnalyzer: ...
```

---

## Project Structure

```
2.0/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ domain/              # Types, protocols, errors
â”‚   â”‚   â”œâ”€â”€ types.py         # Enhanced with Greeks, timezone, volume
â”‚   â”‚   â”œâ”€â”€ enums.py         # Action, recommendation enums
â”‚   â”‚   â”œâ”€â”€ protocols.py     # Provider, calculator interfaces
â”‚   â”‚   â””â”€â”€ errors.py        # Result[T, Error], AppError
â”‚   â”‚
â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â”œâ”€â”€ config.py        # Environment-based configuration
â”‚   â”‚   â””â”€â”€ validation.py    # NEW Phase 2: Startup validation
â”‚   â”‚
â”‚   â”œâ”€â”€ infrastructure/
â”‚   â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”‚   â”œâ”€â”€ tradier.py   # Updated Phase 1: @retry, @circuit_breaker
â”‚   â”‚   â”‚   â””â”€â”€ alphavantage.py
â”‚   â”‚   â”œâ”€â”€ database/
â”‚   â”‚   â”‚   â”œâ”€â”€ init_schema.py
â”‚   â”‚   â”‚   â””â”€â”€ repositories/
â”‚   â”‚   â”‚       â”œâ”€â”€ earnings.py
â”‚   â”‚   â”‚       â”œâ”€â”€ metadata.py
â”‚   â”‚   â”‚       â””â”€â”€ prices.py
â”‚   â”‚   â””â”€â”€ cache/
â”‚   â”‚       â”œâ”€â”€ memory_cache.py   # L1
â”‚   â”‚       â””â”€â”€ hybrid_cache.py   # NEW Phase 2: L1+L2
â”‚   â”‚
â”‚   â”œâ”€â”€ application/
â”‚   â”‚   â”œâ”€â”€ async_metrics/      # NEW Phase 1: Concurrent processing
â”‚   â”‚   â”‚   â”œâ”€â”€ implied_move_async.py
â”‚   â”‚   â”‚   â””â”€â”€ vrp_analyzer_async.py
â”‚   â”‚   â”œâ”€â”€ metrics/
â”‚   â”‚   â”‚   â”œâ”€â”€ implied_move.py
â”‚   â”‚   â”‚   â”œâ”€â”€ implied_move_interpolated.py  # NEW Phase 4
â”‚   â”‚   â”‚   â”œâ”€â”€ vrp.py
â”‚   â”‚   â”‚   â”œâ”€â”€ consistency.py
â”‚   â”‚   â”‚   â”œâ”€â”€ consistency_enhanced.py       # NEW Phase 4
â”‚   â”‚   â”‚   â”œâ”€â”€ skew.py
â”‚   â”‚   â”‚   â”œâ”€â”€ skew_enhanced.py              # NEW Phase 4
â”‚   â”‚   â”‚   â”œâ”€â”€ term_structure.py
â”‚   â”‚   â”‚   â”œâ”€â”€ execution_quality.py
â”‚   â”‚   â”‚   â”œâ”€â”€ market_cap.py
â”‚   â”‚   â”‚   â””â”€â”€ iv_hv_ratio.py
â”‚   â”‚   â””â”€â”€ services/
â”‚   â”‚       â”œâ”€â”€ analyzer.py
â”‚   â”‚       â”œâ”€â”€ health.py        # NEW Phase 1: Health checks
â”‚   â”‚       â”œâ”€â”€ backfill.py
â”‚   â”‚       â”œâ”€â”€ watchlist.py
â”‚   â”‚       â””â”€â”€ calendar.py
â”‚   â”‚
â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â”œâ”€â”€ logging.py           # Enhanced Phase 1: Correlation IDs
â”‚   â”‚   â”œâ”€â”€ retry.py             # NEW Phase 1
â”‚   â”‚   â”œâ”€â”€ circuit_breaker.py   # NEW Phase 1
â”‚   â”‚   â”œâ”€â”€ tracing.py           # NEW Phase 1
â”‚   â”‚   â”œâ”€â”€ performance.py       # NEW Phase 2
â”‚   â”‚   â”œâ”€â”€ timezone.py          # NEW Phase 2
â”‚   â”‚   â””â”€â”€ rate_limiter.py
â”‚   â”‚
â”‚   â””â”€â”€ container.py             # Updated Phase 1: Health + Async
â”‚
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ unit/
â”‚   â”‚   â”œâ”€â”€ test_async_*.py      # NEW Phase 1
â”‚   â”‚   â”œâ”€â”€ test_retry.py        # NEW Phase 1
â”‚   â”‚   â”œâ”€â”€ test_circuit_breaker.py  # NEW Phase 1
â”‚   â”‚   â”œâ”€â”€ test_tracing.py      # NEW Phase 1
â”‚   â”‚   â”œâ”€â”€ test_health.py       # NEW Phase 1
â”‚   â”‚   â”œâ”€â”€ test_edge_cases.py   # NEW Phase 3
â”‚   â”‚   â”œâ”€â”€ test_timezone.py     # NEW Phase 2
â”‚   â”‚   â””â”€â”€ test_*.py            # Core tests
â”‚   â”œâ”€â”€ integration/
â”‚   â”‚   â”œâ”€â”€ test_resilience.py   # NEW Phase 1
â”‚   â”‚   â”œâ”€â”€ test_operations.py   # NEW Phase 2
â”‚   â”‚   â”œâ”€â”€ test_e2e_*.py        # NEW Phase 2+
â”‚   â”‚   â””â”€â”€ test_*.py
â”‚   â””â”€â”€ performance/
â”‚       â”œâ”€â”€ test_load.py         # NEW Phase 3: 100 ticker load test
â”‚       â””â”€â”€ test_benchmarks.py   # NEW Phase 3: Baselines
â”‚
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ analyze.py               # Updated Phase 1: Use async
â”‚   â”œâ”€â”€ scan.py                  # Updated Phase 1: Use async
â”‚   â”œâ”€â”€ backfill.py
â”‚   â”œâ”€â”€ health_check.py          # NEW Phase 1
â”‚   â””â”€â”€ benchmark.py             # NEW Phase 3
â”‚
â”œâ”€â”€ docs/
â”‚   â”œâ”€â”€ ARCHITECTURE.md          # NEW Phase 2: Updated diagrams
â”‚   â”œâ”€â”€ DEPLOYMENT.md            # NEW Phase 3: Production procedures
â”‚   â”œâ”€â”€ RUNBOOK.md               # NEW Phase 3: Operations
â”‚   â””â”€â”€ TROUBLESHOOTING.md       # NEW Phase 3: Common issues
â”‚
â”œâ”€â”€ data/
â”‚   â””â”€â”€ iv_crush_metrics.db
â”œâ”€â”€ logs/
â”‚   â””â”€â”€ iv_crush.log
â””â”€â”€ Dockerfile, docker-compose.yml  # NEW Phase 3: Optional deployment
```

---

## Key Metrics & Baselines

### Performance Targets

| Metric | MVP | Phase 1 | Phase 3 |
|--------|-----|---------|---------|
| Single ticker | 1000ms | 800ms | <1000ms âœ… |
| 50 tickers | 50,000ms | 2,500ms | <5000ms âœ… |
| 100 tickers | N/A | 5,000ms | <10,000ms âœ… |
| Health check | N/A | 100ms | <100ms âœ… |
| Backfill/quarter | 2000ms | 2000ms | <5000ms âœ… |

### Reliability Targets

| Metric | Target | How |
|--------|--------|-----|
| Retry success rate | 95%+ | @retry decorator, 3 attempts |
| Circuit breaker | 100% recovery | Opens after 5 failures, recovers 60s |
| Cache hit rate | 70%+ | Hybrid L1/L2 cache |
| API availability | 99%+ | Depends on providers (Tradier/AV) |
| Data loss events | 0 | Persistent L2 cache |

### Operational Targets

| Metric | Target | How |
|--------|--------|-----|
| Time to debug error | 5 min | Correlation IDs in logs |
| Config validation | 100% | Startup checks |
| Latency regression detection | Automatic | @track_performance decorator |
| System readiness check | Any time | /health endpoint |

---

## Go/No-Go Criteria

### Before Live Paper Trading (After Day 35 + Phase 2)

- [ ] MVP system working (single ticker < 5s, DB persisting)
- [ ] Phase 1 resilience verified: Async 50 tickers < 5s, retries work, circuit breaker recovers
- [ ] Phase 2 operations verified: Restart preserves cache, config validated, timezones correct
- [ ] 90%+ test coverage (unit + integration)
- [ ] Health check endpoint healthy
- [ ] Load test: 50 tickers in < 5 seconds
- [ ] Backfill complete: 100+ tickers with 12 quarters each
- [ ] Zero known bugs or error cases

### Before Live Real Money Trading (After Day 42 + Phase 3)

- [ ] Paper trading results validated (2+ weeks)
- [ ] Load test: 100 tickers in < 10 seconds
- [ ] Edge case tests: All 20+ scenarios handled
- [ ] Performance benchmarks: All within targets
- [ ] Deployment runbook: Step-by-step tested
- [ ] Monitoring/alerting: Active and tested
- [ ] All Phase 1-3 complete and validated

---

## Success Metrics - Final

### Performance
- 50 tickers scanned in < 5 seconds (10x improvement over 50s sequential)
- Single ticker < 1000ms
- Health checks < 100ms
- No performance regressions (tracked automatically)

### Reliability
- 95%+ transient failure recovery (via retry)
- 100% circuit breaker recovery
- 0 data loss on restart (L2 cache)
- 99.9% uptime (8.64s/day max downtime)

### Operations
- 5 min to debug any error (correlation IDs)
- System status known any time (/health)
- Config errors caught at startup
- Performance regressions detected automatically

---

## Next Steps

1. **Days 1-21:** Follow original MVP timeline
2. **After MVP complete (Day 21):** Transition to Phase 1
3. **Execute Phases 1-4 sequentially:** 25 more days
4. **Day 46:** Fully production-hardened system ready for live trading

---

**Timeline:** 46 days total (21 MVP + 25 hardening)  
**Architecture:** Production-ready with enterprise resilience  
**Status:** Ready to implement
